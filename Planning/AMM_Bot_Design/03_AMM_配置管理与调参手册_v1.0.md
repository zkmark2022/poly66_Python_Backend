# AMM é…ç½®ç®¡ç†ä¸è°ƒå‚æ‰‹å†Œ

> **ç‰ˆæœ¬**: v1.3
> **çŠ¶æ€**: è‰ç¨¿ï¼ˆå¾… Reviewï¼‰
> **é€‚ç”¨èŒƒå›´**: AMM è‡ªåŠ¨åšå¸‚å•†æœºå™¨äººå…¨éƒ¨å¯è°ƒå‚æ•°çš„é›†ä¸­ç®¡ç†ã€çƒ­æ›´æ–°è§„åˆ™ã€ä¸è°ƒå‚æŒ‡å—
> **å¯¹é½æ–‡æ¡£**: ã€ŠAMM æ¨¡å—è®¾è®¡ v7.1ã€‹ã€ã€Šæ¥å£ä¸äº‹ä»¶æµå¥‘çº¦ v1.4ã€‹ã€ã€Šæ•°æ®å­—å…¸ä¸çŠ¶æ€æœºè§„èŒƒ v1.3ã€‹ã€ã€ŠWAL é¢„å†™æ—¥å¿—ä¸æ•…éšœæ¢å¤è®¾è®¡ v1.1ã€‹ã€ã€Šæ’®åˆå¼•æ“ä¸æ¸…ç®—æµç¨‹è®¾è®¡ v1.2ã€‹
> **æ—¥æœŸ**: 2026-02-28

---

## ç›®å½•

1. [æ–‡æ¡£èŒƒå›´ä¸è®¾è®¡ç›®æ ‡](#ç¬¬ä¸€ç« æ–‡æ¡£èŒƒå›´ä¸è®¾è®¡ç›®æ ‡)
2. [é…ç½®æ¶æ„æ€»è§ˆ](#ç¬¬äºŒç« é…ç½®æ¶æ„æ€»è§ˆ)
3. [å‚æ•°å®Œæ•´å­—å…¸](#ç¬¬ä¸‰ç« å‚æ•°å®Œæ•´å­—å…¸)
4. [çƒ­æ›´æ–°è§„åˆ™ä¸å®‰å…¨çº¦æŸ](#ç¬¬å››ç« çƒ­æ›´æ–°è§„åˆ™ä¸å®‰å…¨çº¦æŸ)
5. [å¯åŠ¨æ—¶é…ç½®åŠ è½½æµç¨‹](#ç¬¬äº”ç« å¯åŠ¨æ—¶é…ç½®åŠ è½½æµç¨‹)
6. [åœºæ™¯åŒ–è°ƒå‚æŒ‡å—](#ç¬¬å…­ç« åœºæ™¯åŒ–è°ƒå‚æŒ‡å—)
7. [å‚æ•°è”åŠ¨å…³ç³»å›¾](#ç¬¬ä¸ƒç« å‚æ•°è”åŠ¨å…³ç³»å›¾)
8. [å‘Šè­¦ä¸ç›‘æ§é…ç½®](#ç¬¬å…«ç« å‘Šè­¦ä¸ç›‘æ§é…ç½®)
9. [è°ƒå‚æ“ä½œè§„èŒƒ](#ç¬¬ä¹ç« è°ƒå‚æ“ä½œè§„èŒƒ)
10. [é™„å½•](#é™„å½•)

---

## ç¬¬ä¸€ç« ï¼šæ–‡æ¡£èŒƒå›´ä¸è®¾è®¡ç›®æ ‡

### 1.1 æ–‡æ¡£èŒƒå›´

æœ¬æ–‡æ¡£æ˜¯ AMM æœºå™¨äºº**å”¯ä¸€çš„é…ç½®å‚è€ƒæ‰‹å†Œ**ï¼Œè¦†ç›–ï¼š

- å…¨éƒ¨ 87+ å¯è°ƒå‚æ•°çš„å®šä¹‰ã€é»˜è®¤å€¼ã€åˆæ³•èŒƒå›´ã€æ‰€å±æ¨¡å—
- é…ç½®å­˜å‚¨å±‚çº§ï¼ˆå¯åŠ¨é…ç½®æ–‡ä»¶ â†’ Redis çƒ­æ›´æ–°å±‚ â†’ å†…å­˜è¿è¡Œå±‚ï¼‰
- çƒ­æ›´æ–° vs å†·æ›´æ–°çš„åˆ’åˆ†è§„åˆ™ä¸å®‰å…¨çº¦æŸ
- é¢å‘ä¸åŒè¿è¥åœºæ™¯çš„è°ƒå‚æŒ‡å—ï¼ˆæ–°å¸‚åœºä¸Šçº¿ã€é«˜æ³¢åŠ¨åº”æ€¥ã€åº“å­˜å¤±è¡¡ä¿®å¤ç­‰ï¼‰
- å‚æ•°é—´çš„è”åŠ¨å…³ç³»ä¸çº¦æŸæ¡ä»¶
- å‘Šè­¦é˜ˆå€¼ä¸ç›‘æ§é…ç½®

**ä¸åœ¨èŒƒå›´å†…**: å‚æ•°å¯¹åº”çš„ç®—æ³•æ¨å¯¼ç»†èŠ‚ï¼ˆè§ã€ŠAMM æ¨¡å—è®¾è®¡ v7.1ã€‹ï¼‰ï¼Œäº¤æ˜“ç³»ç»Ÿä¾§çš„é…ç½®ï¼ˆè§ã€Šæ’®åˆå¼•æ“ä¸æ¸…ç®—æµç¨‹è®¾è®¡ v1.2ã€‹ï¼‰ã€‚

### 1.2 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| **é›†ä¸­ç®¡ç†** | æ•£è½åœ¨ 11 ä¸ª Config ç±»ä¸­çš„å‚æ•°å½’é›†ä¸ºå•ä¸€å‚è€ƒæº |
| **å®‰å…¨çƒ­æ›´æ–°** | è¿è¥äººå‘˜å¯åœ¨ä¸åœæœºçš„æƒ…å†µä¸‹è°ƒæ•´ç­–ç•¥å‚æ•°ï¼ŒåŒæ—¶æœç»å±é™©å‚æ•°è¢«è¯¯æ”¹ |
| **å¯å®¡è®¡** | æ¯æ¬¡é…ç½®å˜æ›´å†™å…¥å®¡è®¡æ—¥å¿—ï¼Œæ”¯æŒå›æº¯ |
| **ç¯å¢ƒéš”ç¦»** | dev / staging / prod é…ç½®åˆ†å±‚ç®¡ç†ï¼Œé˜²æ­¢è¯¯ç”¨ |

### 1.3 æœ¯è¯­çº¦å®š

| æœ¯è¯­ | å«ä¹‰ |
|------|------|
| **å†·é…ç½®** | éœ€è¦é‡å¯ AMM è¿›ç¨‹æ‰èƒ½ç”Ÿæ•ˆçš„å‚æ•° |
| **çƒ­é…ç½®** | é€šè¿‡ Redis `amm:config:{market_id}` å†™å…¥åï¼ŒAMM åœ¨ä¸‹ä¸€ä¸ªå†³ç­–å‘¨æœŸè‡ªåŠ¨åŠ è½½ |
| **å®‰å…¨é”å®š** | å‚æ•°è¢«æ ‡è®°ä¸º LOCKEDï¼Œçƒ­æ›´æ–°æ¥å£æ‹’ç»ä¿®æ”¹ï¼Œå¿…é¡»èµ°ä»£ç å‘ç‰ˆæµç¨‹ |
| **è”åŠ¨çº¦æŸ** | ä¿®æ”¹å‚æ•° A æ—¶å¿…é¡»åŒæ­¥æ£€æŸ¥å‚æ•° B çš„åˆæ³•æ€§ |
| **AMM_PAUSE** | AMM æœºå™¨äººçº§ç´§æ€¥åœæœºï¼šæ’¤é”€å…¨éƒ¨æŒ‚å• + åœæ­¢å‘å• + è¿›å…¥ EMERGENCY çŠ¶æ€ã€‚**ä¸ä¿®æ”¹** `markets.status` |
| **ç³»ç»Ÿ HALTED** | å¸‚åœºå…¨å±€ç†”æ–­ï¼ˆ`markets.status = 'HALTED'`ï¼‰ï¼Œä»…ç”±æ’®åˆå¼•æ“æ’ç­‰å¼æ ¡éªŒå¤±è´¥è§¦å‘ï¼ŒAMM æ— æƒè§¦å‘ |

---

## ç¬¬äºŒç« ï¼šé…ç½®æ¶æ„æ€»è§ˆ

### 2.1 ä¸‰å±‚é…ç½®æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     é…ç½®æ¶æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  Layer 3: å†…å­˜è¿è¡Œå±‚ (AMMConfigV6 dataclass)              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚
â”‚  Â· è¿›ç¨‹å¯åŠ¨æ—¶ä» Layer 1 + Layer 2 åˆå¹¶åŠ è½½                  â”‚
â”‚  Â· æ¯ 30 ç§’æ£€æµ‹ Redis config_version å˜æ›´                   â”‚
â”‚  Â· å˜æ›´æ£€æµ‹åˆ° â†’ å¢é‡åˆå¹¶ â†’ æ ¡éªŒ â†’ åŸå­æ›¿æ¢                  â”‚
â”‚  Â· å†…å­˜ä¸­çš„è¿è¡Œæ—¶é…ç½®æ˜¯ Source of Truth                     â”‚
â”‚                                                           â”‚
â”‚  Layer 2: Redis çƒ­æ›´æ–°å±‚ (amm:config:{market_id})         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚
â”‚  Â· å­˜å‚¨è¿è¥äººå‘˜é€šè¿‡ç®¡ç†æ¥å£æ¨é€çš„å‚æ•°è¦†ç›– (override)         â”‚
â”‚  Â· ä»…å­˜å¢é‡ä¿®æ”¹éƒ¨åˆ†ï¼Œéå…¨é‡é…ç½®                              â”‚
â”‚  Â· æ¯æ¬¡å†™å…¥é€’å¢ config_version                              â”‚
â”‚  Â· æ”¯æŒ TTL å‹ä¸´æ—¶è¦†ç›–ï¼ˆå¦‚åº”æ€¥æ‰©å¤§ spread 30 åˆ†é’Ÿï¼‰         â”‚
â”‚                                                           â”‚
â”‚  Layer 1: å¯åŠ¨é…ç½®æ–‡ä»¶ (config/{env}.yaml)                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚
â”‚  Â· YAML æ ¼å¼ï¼Œå«å…¨é‡é»˜è®¤å€¼                                  â”‚
â”‚  Â· çº³å…¥ç‰ˆæœ¬ç®¡ç† (Git)                                      â”‚
â”‚  Â· æ¯ä¸ª market_id å¯æœ‰ç‹¬ç«‹è¦†ç›–æ®µ                            â”‚
â”‚  Â· å˜æ›´éœ€ Code Review + CI æ ¡éªŒ                            â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜å…ˆçº§: Layer 2 (Redis) > Layer 1 (YAML) > ä»£ç ç¡¬ç¼–ç é»˜è®¤å€¼
```

### 2.2 é…ç½®æ–‡ä»¶ç»“æ„ç¤ºä¾‹

```yaml
# config/prod.yaml
amm:
  global_defaults:
    as_config:
      gamma_short: 2.5
      gamma_mid: 1.5
      gamma_long: 0.8
      time_smoothing_kappa: 24.0
    defense_config:
      daily_loss_limit: 100000
      price_jump_threshold: 0.15
    exploration_config:
      spread: 5
      levels: 5
    stabilization_config:
      spread: 2
      levels: 5

  market_overrides:
    "market_uuid_001":
      as_config:
        gamma_mid: 2.0           # æ­¤å¸‚åœºæ³¢åŠ¨æ›´å¤§ï¼Œè°ƒé«˜Î³
      defense_config:
        daily_loss_limit: 50000  # å°å‹å¸‚åœºé™ä½é¢„ç®—
    "market_uuid_002":
      exploration_config:
        max_duration_ms: 7200000 # å»¶é•¿æ¢ç´¢æœŸè‡³2å°æ—¶
```

### 2.3 Redis çƒ­æ›´æ–°å­˜å‚¨ç»“æ„

```
Key:   amm:config:{market_id}
Type:  Hash
Fields:
  config_version        â†’ int (å•è°ƒé€’å¢)
  updated_at            â†’ ISO8601 timestamp
  updated_by            â†’ operator_id
  override_json         â†’ JSON string (ä»…å«è¢«è¦†ç›–çš„å‚æ•°è·¯å¾„)

  # override_json ç¤ºä¾‹:
  # {
  #   "as_config.gamma_mid": 2.0,
  #   "defense_config.daily_loss_limit": 50000,
  #   "stabilization_config.spread": 3
  # }
```

---

## ç¬¬ä¸‰ç« ï¼šå‚æ•°å®Œæ•´å­—å…¸

### 3.1 AMMConfigV6 â€” é¡¶å±‚é…ç½®

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `market_id` | string | â€” | UUID | âŒ LOCKED | å¸‚åœºæ ‡è¯†ï¼Œå¯åŠ¨åä¸å¯å˜ |
| `amm_user_id` | string | â€” | UUID | âŒ LOCKED | AMM ç³»ç»Ÿè´¦æˆ· ID |
| `initial_funding_cents` | int | â€” | â‰¥ 10000 | âŒ LOCKED | åˆå§‹èµ„é‡‘ï¼ˆç¾åˆ†ï¼‰ï¼Œå†³å®šæ•´ä½“é£é™©æ•å£ |
| `auto_reinvest_enabled` | bool | true | â€” | âœ… | å¯ç”¨ Mint è‡ªåŠ¨å†æŠ•èµ„ |
| `auto_reinvest_threshold_cents` | int | 50000 | â‰¥ 10000 | âœ… | ç°é‡‘ä½™é¢è¶…è¿‡æ­¤é˜ˆå€¼æ—¶è§¦å‘ Mint |
| `min_inventory_ratio` | float | 0.20 | 0.10 â€“ 0.50 | âœ… | æœ€ä½åº“å­˜æ¯”ä¾‹ï¼ˆv7.1 åŠ ä¸¥è‡³ 0.30 è§¦å‘ Mint æ¡ä»¶ï¼‰ |
| `oracle_guard_enabled` | bool | true | â€” | âœ… | å¯ç”¨ Oracle ä»·æ ¼åå·®ä¿æŠ¤ |
| `oracle_deviation_warning` | float | 0.05 | 0.01 â€“ 0.20 | âœ… | Oracle åå·®é¢„è­¦é˜ˆå€¼ï¼ˆä»…å‘Šè­¦ï¼‰ |
| `oracle_deviation_halt` | float | 0.20 | 0.05 â€“ 0.50 | âœ… | Oracle åå·®åœæœºé˜ˆå€¼ |

### 3.2 ThreeLayerPricingConfig â€” ä¸‰å±‚å®šä»·

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `anchor_initial_weight` | float | 0.70 | 0.0 â€“ 1.0 | âœ… | å¤–éƒ¨é”šå®šä»·æ ¼åˆå§‹æƒé‡ï¼ˆt=0ï¼‰ |
| `anchor_decay_ms` | int | 3600000 | â‰¥ 60000 | âœ… | é”šå®šè¡°å‡æ—¶é—´å¸¸æ•°ï¼ˆmsï¼‰ï¼Œweight = max(0, 1-t/Ï„) |
| `microprice_weight` | float | 0.20 | 0.0 â€“ 1.0 | âœ… | è®¢å•ç°¿å¾®ä»·æ ¼ä¿¡å·æƒé‡ |
| `microprice_min_depth` | int | 10 | â‰¥ 0 | âœ… | æ¿€æ´»å¾®ä»·æ ¼æ‰€éœ€æœ€ä½éAMMæ·±åº¦ï¼ˆä»½æ•°ï¼‰ |
| `base_learning_rate` | float | 0.15 | 0.02 â€“ 0.30 | âœ… | åéªŒä»·æ ¼å­¦ä¹ ç‡ Î±_baseï¼›å®é™… Î± = base/âˆš(trades_per_min+1) |

**è”åŠ¨çº¦æŸ**: `anchor_initial_weight + microprice_weight â‰¤ 1.0`ï¼ˆå‰©ä½™æƒé‡è‡ªåŠ¨åˆ†é…ç»™åéªŒä»·æ ¼ï¼‰

### 3.3 ExplorationConfig â€” æ¢ç´¢é˜¶æ®µ

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `spread` | int | 5 | 1 â€“ 20 | âœ… | æ¢ç´¢æœŸåŠä»·å·®ï¼ˆç¾åˆ†ï¼‰ï¼Œæ§åˆ¶é£é™©æš´éœ² |
| `qty_ratio` | float | 0.25 | 0.05 â€“ 0.50 | âœ… | æŒ‚å•é‡å æ­£å¸¸é‡æ¯”ä¾‹ï¼Œé™åˆ¶å•ç¬”æŸå¤± |
| `gradient_type` | string | "LINEAR" | LINEAR / GEOMETRIC | âœ… | æ¢¯åº¦ç±»å‹ï¼Œæ¢ç´¢æœŸæ¨è LINEAR |
| `linear_step` | int | 1 | 1 â€“ 5 | âœ… | çº¿æ€§æ¢¯åº¦æ¯å±‚ä»·æ ¼é€’å¢ï¼ˆç¾åˆ†ï¼‰ |
| `levels` | int | 5 | 2 â€“ 10 | âœ… | æŒ‚å•æ¢¯åº¦å±‚æ•° |
| `cancel_interval_ms` | int | 20000 | 5000 â€“ 120000 | âœ… | å®šæ—¶æ’¤å•é‡æŒ‚é—´éš”ï¼ˆmsï¼‰ |
| `max_duration_ms` | int | 3600000 | 300000 â€“ 86400000 | âœ… | æ¢ç´¢æœŸæœ€é•¿æŒç»­æ—¶é—´ï¼ˆmsï¼‰ |
| `min_volume` | int | 200 | 0 â€“ 10000 | âœ… | è½¬å…¥ç¨³å®šæœŸçš„æœ€ä½æˆäº¤é‡é—¨æ§› |
| `price_stability_window_ms` | int | 900000 | 60000 â€“ 3600000 | âœ… | ä»·æ ¼ç¨³å®šåˆ¤å®šçª—å£ï¼ˆmsï¼‰ |
| `price_stability_threshold` | float | 0.03 | 0.01 â€“ 0.20 | âœ… | çª—å£å†…æ³¢åŠ¨ç‡ä½äºæ­¤é˜ˆå€¼è§†ä¸ºç¨³å®š |

**é˜¶æ®µè½¬æ¢æ¡ä»¶ï¼ˆä¸‰é€‰ä¸€æ»¡è¶³å³å¯ï¼‰**:
1. `max_duration_ms` åˆ°æœŸï¼ˆTIME_EXPIREDï¼‰
2. ç´¯è®¡æˆäº¤é‡ â‰¥ `min_volume`ï¼ˆVOLUME_REACHEDï¼‰
3. `price_stability_window_ms` å†…æ³¢åŠ¨ç‡ < `price_stability_threshold`ï¼ˆPRICE_STABLEï¼‰

### 3.4 StabilizationConfig â€” ç¨³å®šé˜¶æ®µ

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `spread` | int | 2 | 1 â€“ 10 | âœ… | ç¨³å®šæœŸåŠä»·å·®ï¼ˆç¾åˆ†ï¼‰ï¼Œæ”¶çª„ä»¥æå‡ç”¨æˆ·ä½“éªŒ |
| `qty_ratio` | float | 1.0 | 0.20 â€“ 2.0 | âœ… | æŒ‚å•é‡å€ç‡ï¼ˆ1.0 = æ­£å¸¸é‡ï¼‰ |
| `gradient_type` | string | "GEOMETRIC" | LINEAR / GEOMETRIC | âœ… | æ¢¯åº¦ç±»å‹ï¼Œç¨³å®šæœŸæ¨è GEOMETRIC |
| `geometric_ratio` | float | 1.05 | 1.01 â€“ 1.20 | âœ… | å‡ ä½•æ¢¯åº¦æ¯”ç‡ P_i = P_base Ã— ratio^i |
| `levels` | int | 5 | 2 â€“ 10 | âœ… | æ¢¯åº¦å±‚æ•° |
| `qty_decay` | float | 0.70 | 0.30 â€“ 1.0 | âœ… | è¿œå±‚é‡è¡°å‡ Q_i = Q_base Ã— decay^i |
| `cancel_on_trade` | bool | true | â€” | âœ… | æ¯ç¬”æˆäº¤åç«‹å³é‡æ–°æŒ‚å• |
| `cancel_on_price_move` | float | 0.02 | 0.005 â€“ 0.10 | âœ… | å…¬å…ä»·æ ¼ç§»åŠ¨è¶…è¿‡æ­¤æ¯”ä¾‹è§¦å‘é‡æŒ‚ |
| `max_order_age_ms` | int | 300000 | 30000 â€“ 600000 | âœ… | è®¢å•æœ€å¤§å­˜æ´»æ—¶é—´ï¼ˆmsï¼‰ï¼Œè¶…æ—¶å¼ºåˆ¶ Replace |

### 3.5 PhaseRollbackConfig â€” é˜¶æ®µå›é€€

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `volatility_threshold` | float | 0.10 | 0.03 â€“ 0.30 | âœ… | 5åˆ†é’Ÿæ³¢åŠ¨ç‡é˜ˆå€¼ï¼Œè¶…è¿‡è§¦å‘å›é€€è‡³ EXPLORATION |
| `pnl_rollback_threshold` | int | 50000 | â‰¥ 10000 (cents) | âœ… | æ—¥å†…äºæŸé˜ˆå€¼ï¼ˆ= daily_loss_limit Ã— 50%ï¼‰ |
| `cooldown_ms` | int | 600000 | 60000 â€“ 1800000 | âœ… | å›é€€åå†·å´æœŸï¼ˆmsï¼‰ï¼Œé˜²æ­¢é˜¶æ®µéœ‡è¡ |

**è”åŠ¨çº¦æŸ**: `pnl_rollback_threshold` åº” â‰¤ `defense_config.daily_loss_limit`

### 3.6 ASConfig â€” Avellaneda-Stoikov é£é™©ç®¡ç†

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `gamma_short` | float | 2.5 | 0.5 â€“ 5.0 | âœ… | çŸ­æœŸå¸‚åœºï¼ˆ<7å¤©ï¼‰é£é™©åŒæ¶ç³»æ•°ï¼Œæ¿€è¿›æ¸…åº“å­˜ |
| `gamma_mid` | float | 1.5 | 0.5 â€“ 3.0 | âœ… | ä¸­æœŸå¸‚åœºï¼ˆ7-90å¤©ï¼‰Î³ï¼Œæ ‡å‡†åšå¸‚æ¨èèµ·ç‚¹ |
| `gamma_long` | float | 0.8 | 0.1 â€“ 2.0 | âœ… | é•¿æœŸå¸‚åœºï¼ˆ>90å¤©ï¼‰Î³ï¼Œä¿å®ˆé¿å…è¿‡åº¦è°ƒæ•´ |
| `time_smoothing_kappa` | float | 24.0 | 1.0 â€“ 168.0 | âœ… | æ—¶é—´å¹³æ»‘å¸¸æ•° Îºï¼ˆå°æ—¶ï¼‰ï¼ŒÏ„(h)=h/(h+Îº) |
| `spread_skew_factor` | float | 0.5 | 0.0 â€“ 1.0 | âœ… | åº“å­˜åæ–œå¯¹ä»·å·®çš„è°ƒèŠ‚ç³»æ•° |
| `qty_skew_factor` | float | 0.3 | 0.0 â€“ 1.0 | âœ… | åº“å­˜åæ–œå¯¹æŒ‚å•é‡çš„è°ƒèŠ‚ç³»æ•° |
| `min_price` | int | 5 | 1 â€“ 30 | âœ… | æœ€ä½æœ‰æ•ˆä»·æ ¼ï¼ˆç¾åˆ†ï¼‰ï¼Œä½äºæ­¤ä¸æŠ¥ä»· |
| `max_price` | int | 95 | 70 â€“ 99 | âœ… | æœ€é«˜æœ‰æ•ˆä»·æ ¼ï¼ˆç¾åˆ†ï¼‰ |
| `min_adjustment` | int | 1 | 0 â€“ 5 | âœ… | æœ€å°ä¿ç•™ä»·æ ¼è°ƒæ•´é‡ï¼ˆç¾åˆ†ï¼‰ï¼Œé˜²æ­¢ ÏƒÂ²â†’0 |

**è”åŠ¨çº¦æŸ**: `min_price < max_price`ï¼›`min_price + spread < max_price - spread`ï¼ˆç¡®ä¿æŠ¥ä»·åŒºé—´æœ‰æ•ˆï¼‰

**v7.1 æ ¸å¿ƒå…¬å¼**:
```
r = s - q Â· Î³ Â· ÏƒÂ² Â· Ï„(h)
å…¶ä¸­:
  s = å…¬å…ä»·æ ¼ï¼ˆç¾åˆ†ï¼‰
  q = åº“å­˜åæ–œ âˆˆ [-1, 1]
  Î³ = æ ¹æ®å¸‚åœºå‰©ä½™å¤©æ•°é€‰æ‹© gamma_short/mid/long
  Ïƒ = æ³¢åŠ¨ç‡ï¼ˆç¾åˆ†ï¼Œç”± VolatilityEstimator è®¡ç®—ï¼‰
  Ï„(h) = h/(h+Îº)ï¼Œh = è·åˆ°æœŸå°æ—¶æ•°
```

### 3.7 GradientConfig â€” æ¢¯åº¦æŒ‚å•

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `linear_step` | int | 1 | 1 â€“ 5 | âœ… | çº¿æ€§æ¢¯åº¦æ¯å±‚ä»·æ ¼å¢é‡ï¼ˆç¾åˆ†ï¼‰ |
| `linear_levels` | int | 5 | 2 â€“ 10 | âœ… | çº¿æ€§æ¢¯åº¦å±‚æ•°ï¼ˆæ¢ç´¢æœŸä½¿ç”¨ï¼‰ |
| `linear_qty_increase` | float | 0.20 | 0.0 â€“ 0.50 | âœ… | çº¿æ€§æ¢¯åº¦æ¯å±‚é‡å¢æ¯”ï¼ˆå€’é‡‘å­—å¡”ï¼‰ |
| `geometric_ratio` | float | 1.05 | 1.01 â€“ 1.20 | âœ… | å‡ ä½•æ¢¯åº¦æ¯”ç‡ |
| `geometric_levels` | int | 5 | 2 â€“ 10 | âœ… | å‡ ä½•æ¢¯åº¦å±‚æ•°ï¼ˆç¨³å®šæœŸä½¿ç”¨ï¼‰ |
| `qty_decay` | float | 0.70 | 0.30 â€“ 1.0 | âœ… | å‡ ä½•æ¢¯åº¦é‡è¡°å‡å› å­ |

### 3.8 DefenseStackConfig â€” ä¸‰å±‚é˜²å¾¡

#### 3.8.1 Layer 1: å…¨å±€é¢„ç®—ä¸ç´§æ€¥åœæœº

> **âš ï¸ v1.1 æœ¯è¯­ä¿®æ­£**ï¼ˆå¯¹é½ WAL v1.1 Â§5 ç†”æ–­æ¶æ„ï¼‰:
> ç³»ç»Ÿçº§ `HALTED` æ˜¯ `markets.status` çš„å…¨å±€ç†”æ–­çŠ¶æ€ï¼Œä»…ç”±æ’ç­‰å¼æ ¡éªŒå¤±è´¥ï¼ˆå¦‚ `INVARIANT_RESERVE`ï¼‰è§¦å‘ï¼Œ
> AMM ä½œä¸ºç”¨æˆ·çº§æœºå™¨äººè´¦æˆ·ï¼ˆ`amm_user_id`ï¼‰**æ— æƒä¿®æ”¹ `markets.status`**ã€‚
> AMM è‡ªèº«çš„ç´§æ€¥åœæœºåŠ¨ä½œç»Ÿä¸€ä½¿ç”¨ **AMM_PAUSE**ï¼ˆæ’¤é”€å…¨éƒ¨æŒ‚å• + åœæ­¢å‘å• + è¿›å…¥ EMERGENCY çŠ¶æ€ï¼‰ï¼Œ
> ä¸ç³»ç»Ÿçº§ `HALTED` ä¸¥æ ¼åŒºåˆ†ã€‚

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `daily_loss_limit` | int | 100000 | 10000 â€“ 1000000 (cents) | âœ… | æ—¥äºæŸä¸Šé™ï¼Œè¶…è¿‡è§¦å‘ KILL_SWITCH |
| `price_jump_threshold` | float | 0.15 | 0.05 â€“ 0.50 | âœ… | çª—å£å†…ä»·æ ¼è·³å˜é˜ˆå€¼ï¼Œè¶…è¿‡è§¦å‘ **AMM_PAUSE**ï¼ˆæ’¤å•+åœæ­¢å‘å•ï¼‰ |
| `price_jump_window_ms` | int | 300000 | 60000 â€“ 900000 | âœ… | ä»·æ ¼è·³å˜æ£€æµ‹çª—å£ï¼ˆmsï¼‰ |
| `api_error_threshold` | float | 0.10 | 0.01 â€“ 0.30 | âœ… | API é”™è¯¯ç‡é˜ˆå€¼ï¼Œè¶…è¿‡è§¦å‘ **AMM_PAUSE** |
| `max_latency_ms` | int | 100 | 10 â€“ 1000 | âœ… | WebSocket æœ€å¤§å¯æ¥å—å»¶è¿Ÿï¼ˆmsï¼‰ï¼Œè¶…è¿‡è§¦å‘ **AMM_PAUSE** |

#### 3.8.2 Layer 2: åº“å­˜ç¡¬é™

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `inventory_warning_threshold` | float | 0.60 | 0.30 â€“ 0.80 | âœ… | åº“å­˜å¤±è¡¡é¢„è­¦ â†’ WIDEN åŠ¨ä½œ |
| `inventory_danger_threshold` | float | 0.80 | 0.50 â€“ 0.95 | âœ… | åº“å­˜å±é™© â†’ ONE_SIDE åŠ¨ä½œ |
| `inventory_hard_limit` | float | 0.90 | 0.80 â€“ 0.99 | âœ… | åº“å­˜æé™ â†’ KILL åŠ¨ä½œ |
| `spread_multiplier_warning` | float | 1.5 | 1.0 â€“ 3.0 | âœ… | WIDEN æ—¶ä»·å·®æ”¾å¤§å€æ•° |
| `spread_multiplier_danger` | float | 3.0 | 2.0 â€“ 5.0 | âœ… | ONE_SIDE æ—¶ä»·å·®æ”¾å¤§å€æ•° |
| `distress_max_discount` | int | 5 | 0 â€“ 15 (cents) | âœ… | å›°å¢ƒæŠ˜ä»·æœ€å¤§å€¼ï¼ˆçº¿æ€§ç¼©æ”¾ï¼‰ |

**è”åŠ¨çº¦æŸ**: `warning < danger < hard_limit`ï¼›`spread_multiplier_warning < spread_multiplier_danger`

> **âš ï¸ v1.1 åº“å­˜æ•°æ®æƒå¨æ€§åŸåˆ™**ï¼ˆå¯¹é½æ¥å£å¥‘çº¦ v1.3 Â§2.4 + Â§5.1ï¼‰:
>
> åº“å­˜é£æ§æŒ‡æ ‡ï¼ˆskewã€threshold åˆ¤å®šï¼‰æ‰€ä¾èµ–çš„ `yes_volume` / `no_volume` / `cash_cents` **å¿…é¡»æ¥æºäº
> Redis `amm:inventory` æˆ– DB `positions` è¡¨**ï¼Œä¸¥ç¦ä»…é€šè¿‡æœ¬åœ°ç´¯åŠ è®¢å•æˆäº¤é‡æ¥æ¨ç®—ã€‚åŸå› ï¼š
>
> 1. **Auto-Netting é¢„é˜²**: AMM è´¦æˆ·é¡»è®¾ç½® `auto_netting_enabled = false`ï¼ˆæ¥å£å¥‘çº¦ Â§2.4ï¼‰ï¼Œ
>    æ’®åˆå¼•æ“è·³è¿‡å¯¹ AMM çš„è‡ªåŠ¨å‡€é¢ç»“ç®—ï¼Œé¿å… Netting å¯¼è‡´çš„åº“å­˜çªå˜ã€‚
>    âš ï¸ **MVP æ³¨æ„**: å½“å‰æ¸…ç®—ä»£ç  `execute_netting_if_needed` **å°šæœªè¯»å–æ­¤æ ‡å¿—**ï¼ˆP0 Blockerï¼‰ï¼Œ
>    éœ€è¦åœ¨ AMM ä¸Šçº¿å‰å®Œæˆæ’®åˆå¼•æ“ä¾§æ”¹åŠ¨ï¼ˆè§æ¥å£å¥‘çº¦ Â§2.4ï¼‰ã€‚åœ¨æ”¹åŠ¨å®Œæˆå‰ï¼Œ
>    AMM çš„åº“å­˜**å¯èƒ½è¢«æ¸…ç®—å±‚å¼ºåˆ¶ Netting**ï¼Œå¯¼è‡´ Redis/DB ä¸é¢„æœŸä¸¥é‡åç¦»ã€‚
> 2. **Mint/Burn ç›´æ›´æ–°**: ç‰¹æƒ Mint/Burn ä¸ç»è¿‡æ’®åˆï¼ŒAMM åœ¨ REST æˆåŠŸåç›´æ¥æ›´æ–° Redisï¼ˆæ¥å£å¥‘çº¦ Â§5.1ï¼‰ï¼Œ
>    æ­¤è·¯å¾„ä¸æˆäº¤äº‹ä»¶æ¶ˆè´¹è·¯å¾„å¹¶è¡Œï¼Œæœ¬åœ°ç´¯åŠ æ— æ³•æ„ŸçŸ¥ã€‚
> 3. **Redis â†” DB å®šæœŸå¯¹è´¦**: æ¯ `reconciliation_interval_ms`ï¼ˆé»˜è®¤ 300sï¼‰æ‰§è¡Œå…¨é‡æ ¡éªŒï¼Œ
>    å‘ç°æ¼‚ç§»è¶…è¿‡ tolerance æ—¶ä»¥ DB ä¸ºå‡†è¦†ç›– Redisï¼Œå¹¶è§¦å‘å‘Šè­¦ã€‚
>
> **v1.2 é˜²å¾¡çºµæ·±è¡¥å…… â€” Netting äº‹ä»¶è®¢é˜…æœºåˆ¶**:
>
> å³ä¾¿ AMM è´¦æˆ·å·²è®¾ç½® `auto_netting_enabled = false`ï¼Œä½œä¸º defense-in-depthï¼ŒAMM çš„åº“å­˜æ¨¡å—
> åº”å®ç°ä»¥ä¸‹å¼‚å¸¸æ£€æµ‹é“¾è·¯ï¼š
>
> | é˜¶æ®µ | å®ç°æ–¹å¼ | çŠ¶æ€ |
> |------|---------|------|
> | **MVP** | ä¾èµ– `reconciliation_interval_ms` å®šæœŸå¯¹è´¦ï¼ˆREST æ‹‰å– DB `positions`ï¼‰å‘ç° Netting å¯¼è‡´çš„åç§»ï¼Œè§¦å‘å‘Šè­¦å’Œè‡ªåŠ¨ä¿®æ­£ | ğŸŸ¢ å¯ç”¨ |
> | **Phase 2** | é€šè¿‡ Redis Pub/Sub è®¢é˜… `clearing:netting:{user_id}` äº‹ä»¶ï¼Œå®æ—¶æ£€æµ‹ Netting è§¦å‘ | ğŸ”² å¾…å®ç° |
>
> æ— è®ºå“ªä¸ªé˜¶æ®µï¼Œæ£€æµ‹åˆ° Netting åçš„å¤„ç†é€»è¾‘ç›¸åŒï¼š
> 1. **ç«‹å³æ‹‰å– DB `positions` è¡¨**çš„çœŸå®æŒä»“å€¼ï¼Œè¦†ç›– Redis `amm:inventory`ã€‚
> 2. è§¦å‘ `INVENTORY_NETTING_OVERRIDE` å‘Šè­¦ï¼ˆseverity: CRITICALï¼‰ï¼Œé€šçŸ¥è¿è¥æ’æŸ¥ Netting è§¦å‘åŸå› ã€‚
> 3. åœ¨è¦†ç›–å®Œæˆå‰ï¼Œæš‚åœå½“å‰å†³ç­–å‘¨æœŸçš„æŠ¥ä»·ï¼ˆç­‰ä»·äºä¸€ä¸ªç¬æ€ AMM_PAUSEï¼‰ï¼Œé˜²æ­¢åŸºäºè¿‡æœŸåº“å­˜çš„é”™è¯¯æŠ¥ä»·ã€‚

#### 3.8.3 Layer 3: å¾®è§‚ç»“æ„ä¿æŠ¤

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `vpin_threshold` | float | 0.70 | 0.40 â€“ 0.95 | âœ… | VPIN çŸ¥æƒ…äº¤æ˜“æ¦‚ç‡è­¦æŠ¥é˜ˆå€¼ |
| `vpin_window` | int | 50 | 10 â€“ 200 | âœ… | VPIN è®¡ç®—æ»šåŠ¨çª—å£ï¼ˆç¬”ï¼‰ |

#### 3.8.4 æç«¯ä»·æ ¼ä¿æŠ¤ï¼ˆv7.0ï¼‰

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `extreme_price_kill` | int | 5 | 1 â€“ 20 | âœ… | ä»·æ ¼ â‰¤ X æˆ– â‰¥ (100-X) æ—¶è§¦å‘ KILL |
| `extreme_price_halt` | int | 10 | 5 â€“ 30 | âœ… | ä»·æ ¼ â‰¤ X æˆ– â‰¥ (100-X) æ—¶è§¦å‘ WIDEN |
| `extreme_spread_multiplier` | float | 3.0 | 1.5 â€“ 5.0 | âœ… | æç«¯åŒºä»·å·®æ”¾å¤§å€æ•° |

**è”åŠ¨çº¦æŸ**: `extreme_price_kill < extreme_price_halt`

### 3.9 OracleGuardConfig â€” Oracle ä»·æ ¼ä¿æŠ¤

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `max_oracle_lag_ms` | int | 3000 | 500 â€“ 30000 | âœ… | Oracle æœ€å¤§å¯æ¥å—å»¶è¿Ÿï¼ˆmsï¼‰ï¼Œè¶…è¿‡è¿›å…¥ PASSIVE_MODE |
| `min_deviation_threshold_cents` | int | 2 | 1 â€“ 10 | âœ… | å†…å¤–ä»·æ ¼æœ€å°å®¹å¿åå·®ï¼ˆç¾åˆ†ï¼‰ |
| `deviation_multiplier` | float | 2.0 | 1.0 â€“ 5.0 | âœ… | åŠ¨æ€é˜ˆå€¼ä¹˜æ•° threshold = max(min, k Ã— Ïƒ_cents) |
| `gap_threshold_cents` | int | 5 | 2 â€“ 20 | âœ… | Oracle ä»·æ ¼è·³ç©ºè§¦å‘è§‚å¯ŸæœŸé˜ˆå€¼ï¼ˆç¾åˆ†ï¼‰ |
| `observation_period_ms` | int | 30000 | 5000 â€“ 120000 | âœ… | è·³ç©ºåè§‚å¯ŸæœŸï¼ˆmsï¼‰ï¼Œä»…å…è®¸ asks ä¸å…è®¸ bids |

### 3.10 LVRDefenseConfig â€” LVR é˜²å¾¡

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `velocity_window_ms` | int | 500 | 100 â€“ 5000 | âœ… | å¿«é€Ÿåº“å­˜æŸå¤±æ£€æµ‹çª—å£ï¼ˆmsï¼‰ |
| `velocity_kill_ratio` | float | 0.20 | 0.05 â€“ 0.50 | âœ… | çª—å£å†…å•ä¾§æŸå¤±æ¯”ä¾‹ï¼Œè¶…è¿‡è§¦å‘ KILL |
| `event_shield_window_ms` | int | 900000 | 300000 â€“ 3600000 | âœ… | å·²çŸ¥äº‹ä»¶å‰åé˜²æŠ¤çª—å£ï¼ˆmsï¼‰ |
| `event_qty_ratio` | float | 0.05 | 0.01 â€“ 0.20 | âœ… | äº‹ä»¶çª—å£æœŸé‡ç¼©å‡æ¯”ä¾‹ |
| `event_spread_multiplier` | float | 5.0 | 2.0 â€“ 10.0 | âœ… | äº‹ä»¶çª—å£æœŸä»·å·®æ”¾å¤§å€æ•° |
| `post_fill_delay_ms` | int | 2500 | 500 â€“ 10000 | âœ… | æˆäº¤åå†·å´æœŸï¼ˆmsï¼‰ï¼ŒæœŸé—´ä»…å…è®¸æ’¤å• |

### 3.11 VolatilityEstimator â€” æ³¢åŠ¨ç‡ä¼°è®¡

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | è¯´æ˜ |
|------|------|--------|----------|--------|------|
| `window_size` | int | 30 | 5 â€“ 100 | âœ… | ä»·æ ¼è§‚æµ‹æ»šåŠ¨çª—å£å¤§å° |
| `min_samples` | int | 5 | 2 â€“ 20 | âœ… | æœ€å°æœ‰æ•ˆæ ·æœ¬æ•°ï¼Œä¸è¶³æ—¶ä½¿ç”¨é»˜è®¤æ³¢åŠ¨ç‡ |
| `default_volatility_cents` | int | 2 | 1 â€“ 10 | âœ… | æ ·æœ¬ä¸è¶³æ—¶çš„é»˜è®¤æ³¢åŠ¨ç‡ï¼ˆç¾åˆ†ï¼‰ |
| `sigma_min_cents` | int | 1 | 1 â€“ 5 | âœ… | æ³¢åŠ¨ç‡ä¸‹é™ï¼ˆç¾åˆ†ï¼‰ï¼Œé˜²æ­¢ A-S è°ƒæ•´ä¸ºé›¶ |
| `sigma_max_cents` | int | 15 | 5 â€“ 30 | âœ… | æ³¢åŠ¨ç‡ä¸Šé™ï¼ˆç¾åˆ†ï¼‰ï¼Œé˜²æ­¢å™ªå£°çˆ†ç‚¸ |

> **âš ï¸ v1.1 æ•´æ•°çº¦æŸå¯¹é½**ï¼ˆå¯¹é½æ’®åˆå¼•æ“ v1.2 å‰æè®¾å®š #5ï¼‰:
> æ‰€æœ‰ä»¥ `_cents` ä¸ºåç¼€çš„é…ç½®å‚æ•°**é…ç½®å±‚å­˜å‚¨ä¸º int**ï¼Œä¸å…¨å±€"ç¦æ­¢ float/Decimal"çº¦æŸä¿æŒä¸€è‡´ã€‚
> AMM å†…éƒ¨ A-S å…¬å¼è®¡ç®—è¿‡ç¨‹å…è®¸ä½¿ç”¨æµ®ç‚¹è¿ç®—ï¼ˆå¦‚ `ÏƒÂ² Ã— Î³ Ã— Ï„(h)`ï¼‰ï¼Œä½†åœ¨**è®¢å•ç”Ÿæˆè¾¹ç•Œ**
> å¿…é¡»æ‰§è¡Œ `round_to_int()` å°†æœ€ç»ˆçš„ bid/ask ä»·æ ¼è½¬ä¸ºæ•´æ•°ç¾åˆ†åæ‰å¯æäº¤è‡³æ’®åˆå¼•æ“ã€‚
> æ­¤è¾¹ç•Œä¿è¯åœ¨ `OrderGenerator.generate_orders()` å‡ºå£å¤„å¼ºåˆ¶æ‰§è¡Œã€‚

**v7.1 APV-BVD å…¬å¼**: `Ïƒ_final = max(Ïƒ_min, min(Ïƒ_max, Ïƒ_base Ã— âˆš(P(100-P)/2500)))`

### 3.12 ç³»ç»Ÿçº§é…ç½®ï¼ˆéç­–ç•¥å‚æ•°ï¼‰

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | åˆæ³•èŒƒå›´ | çƒ­æ›´æ–° | æ‰€å±æ¨¡å— | è¯´æ˜ |
|------|------|--------|----------|--------|----------|------|
| `amm_rate_limit` | int | 600 | 100 â€“ 2000 | âŒ | æ¥å£å±‚ | AMM PlaceOrder é€Ÿç‡ä¸Šé™ï¼ˆæ¬¡/åˆ†é’Ÿï¼‰ |
| `replace_rate_limit` | int | 400 | 100 â€“ 1000 | âŒ | æ¥å£å±‚ | Replace ç‹¬ç«‹é€Ÿç‡ï¼ˆæ¬¡/åˆ†é’Ÿ/å¸‚åœºï¼‰ |
| `config_reload_interval_ms` | int | 30000 | 5000 â€“ 120000 | âŒ | é…ç½®ç®¡ç† | Redis config_version æ£€æŸ¥é—´éš” |
| `reconciliation_interval_ms` | int | 300000 | 60000 â€“ 600000 | âœ… | æ•°æ®åŒæ­¥ | Redis â†” DB å…¨é‡å¯¹è´¦é—´éš” |
| `volume_tolerance` | int | 2 | 0 â€“ 10 | âœ… | æ•°æ®åŒæ­¥ | å¯¹è´¦ä»½æ•°å®¹å·®ï¼ˆè¶…è¿‡å‘Šè­¦ï¼‰ |
| `cash_tolerance` | int | 200 | 0 â€“ 1000 | âœ… | æ•°æ®åŒæ­¥ | å¯¹è´¦èµ„é‡‘å®¹å·®ï¼ˆç¾åˆ†ï¼‰ |
| `cost_sum_tolerance` | int | 500 | 0 â€“ 2000 | âœ… | æ•°æ®åŒæ­¥ | å¯¹è´¦æˆæœ¬å’Œå®¹å·®ï¼ˆç¾åˆ†ï¼‰ |
| `ws_snapshot_interval_ms` | int | 30000 | 10000 â€“ 60000 | âŒ | WebSocket | è®¢å•ç°¿å…¨é‡å¿«ç…§æ¨é€é—´éš” |
| `processed_event_ttl_hours` | int | 24 | 6 â€“ 168 | âŒ | äº‹ä»¶å»é‡ | å·²å¤„ç†äº‹ä»¶IDé›†åˆè¿‡æœŸæ—¶é—´ |
| `amm_token_validity_hours` | int | 24 | 1 â€“ 168 | âŒ | è®¤è¯ | AMM æœåŠ¡ä»¤ç‰Œæœ‰æ•ˆæœŸ |
| `market_taker_fee_bps` | int | 200 | 0 â€“ 1000 | âŒ | æ‰‹ç»­è´¹æ„ŸçŸ¥ | å¸‚åœº Taker æ‰‹ç»­è´¹ç‡ï¼ˆbpsï¼‰ï¼Œç”¨äº spread ä¸‹é™æ ¡éªŒã€‚ä» markets è¡¨è¯»å–ï¼Œé AMM è‡ªå®šä¹‰ |
| `market_maker_fee_bps` | int | 100 | 0 â€“ 1000 | âŒ | æ‰‹ç»­è´¹æ„ŸçŸ¥ | å¸‚åœº Maker æ‰‹ç»­è´¹ç‡ï¼ˆbpsï¼‰ï¼ŒAMM æŒ‚å•å¤šä¸º Makerï¼Œæ­¤å€¼å†³å®šå®é™…æˆæœ¬ |

---

## ç¬¬å››ç« ï¼šçƒ­æ›´æ–°è§„åˆ™ä¸å®‰å…¨çº¦æŸ

### 4.1 çƒ­æ›´æ–°åˆ†ç±»

| åˆ†ç±» | æ ‡è¯† | è¡Œä¸º | é€‚ç”¨å‚æ•° |
|------|------|------|---------|
| **HOT** | âœ… | å†™å…¥ Redis â†’ 30 ç§’å†…è‡ªåŠ¨ç”Ÿæ•ˆ | ç­–ç•¥å‚æ•°ï¼ˆspreadã€Î³ã€levels ç­‰ï¼‰ |
| **WARM** | âš ï¸ | å†™å…¥ Redis â†’ ä¸‹ä¸€ä¸ªå†³ç­–å‘¨æœŸç”Ÿæ•ˆ + è§¦å‘å¹³æ»‘è¿‡æ¸¡ | é˜²å¾¡é˜ˆå€¼ã€Oracle é…ç½® |
| **COLD** | âŒ | ä¿®æ”¹ YAML â†’ é‡å¯è¿›ç¨‹ | èº«ä»½æ ‡è¯†ã€é€Ÿç‡é™åˆ¶ã€å­˜å‚¨é…ç½® |
| **LOCKED** | ğŸ”’ | ä»£ç å‘ç‰ˆ + æ•°æ®åº“è¿ç§» | market_idã€amm_user_id |

### 4.2 å®‰å…¨çº¦æŸçŸ©é˜µ

å½“è¿è¥äººå‘˜é€šè¿‡ç®¡ç†æ¥å£æ¨é€çƒ­æ›´æ–°æ—¶ï¼Œç³»ç»Ÿæ‰§è¡Œä»¥ä¸‹æ ¡éªŒé“¾ã€‚

> **v1.2 é‡æ„**: å¼•å…¥å¼ºåˆ¶æ•´æ•°ç±»å‹æ–­è¨€ã€åŠ¨æ€æ‰‹ç»­è´¹æ„ŸçŸ¥ï¼ˆåŸºäºå¸‚åœºå®é™… `maker_fee_bps` å’Œ `max_order_qty`
> è®¡ç®—æœ€åæƒ…å†µï¼‰ã€ä»¥åŠè¶ŠæƒåŠ¨ä½œæ‹¦æˆªï¼ˆé˜²æ­¢ AMM é…ç½®ä¸­æ³¨å…¥ç³»ç»Ÿçº§ HALT çŠ¶æ€ï¼‰ã€‚

```python
# amm/config_validator.py

from typing import Any
from dataclasses import dataclass


@dataclass
class ValidationResult:
    valid: bool
    errors: list[str]


def validate_config_update(
    current_config: dict,
    patch: dict,
    maker_fee_bps: int,
    max_order_qty: int,
) -> ValidationResult:
    """
    AMM è¿è¡Œæ—¶çƒ­æ›´æ–°é…ç½®æ ¡éªŒçŸ©é˜µ (v1.2)

    å‚æ•°:
      current_config: å½“å‰ç”Ÿæ•ˆçš„å®Œæ•´é…ç½®å­—å…¸
      patch:          å¢é‡ä¿®æ”¹ï¼ˆå±•å¹³æˆ–åµŒå¥—å‡å¯ï¼‰
      maker_fee_bps:  å½“å‰å¸‚åœº Maker æ‰‹ç»­è´¹ç‡ï¼ˆä» markets è¡¨è¯»å–ï¼‰
      max_order_qty:  å½“å‰å¸‚åœº max_order_quantityï¼ˆä» markets è¡¨è¯»å–ï¼‰

    æ ¡éªŒé¡ºåº:
      1. COLD / LOCKED é”å®šå‚æ•°æ‹¦æˆª
      2. å¼ºæ•´æ•°ç±»å‹æ ¡éªŒ (é˜²å¾¡æµ®ç‚¹æ³¨å…¥æ’®åˆå¼•æ“)
      3. æ‰‹ç»­è´¹æ„ŸçŸ¥ä¸ä»·å·®çº¦æŸ (é˜²å¾¡ç¡®å®šæ€§å¥—åˆ©äºæŸ)
      4. è¶ŠæƒåŠ¨ä½œæ‹¦æˆª (ç¦æ­¢ AMM è§¦å‘ç³»ç»Ÿçº§ HALT)
      5. ä¸šåŠ¡è”åŠ¨çº¦æŸ (å‚æ•°é—´é€»è¾‘å…³ç³»)
    """
    errors = []

    merged = _deep_merge(current_config, patch)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1. COLD / LOCKED é”å®šå‚æ•°æ£€æŸ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    LOCKED_PARAMS = {"market_id", "amm_user_id", "initial_funding_cents"}
    COLD_PARAMS = {
        "amm_rate_limit", "replace_rate_limit", "config_reload_interval_ms",
        "ws_snapshot_interval_ms", "processed_event_ttl_hours",
    }

    flat_patch = _flatten_dict(patch)
    for key in flat_patch:
        param_name = key.split(".")[-1]
        if param_name in LOCKED_PARAMS:
            errors.append(f"[è¶Šæƒ] LOCKED å‚æ•°ä¸å¯çƒ­æ›´æ–°: {param_name}")
        if param_name in COLD_PARAMS:
            errors.append(f"[æ‹¦æˆª] COLD å‚æ•°éœ€ä¿®æ”¹ YAML å¹¶é‡å¯è¿›ç¨‹ç”Ÿæ•ˆ: {param_name}")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2. å¼ºæ•´æ•°ç±»å‹æ ¡éªŒ (Strict Integer Type Validation)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # å‡¡æ˜¯æ¶‰åŠç¾åˆ† (_cents)ã€ä»½æ•° (qty)ã€å±‚çº§ (levels)ã€æ¯«ç§’ (_ms) çš„å¿…é¡»ä¸º strict intã€‚
    # å¯¹é½æ’®åˆå¼•æ“ v1.2 å‰æè®¾å®š #5: "æ‰€æœ‰é‡‘é¢/ä»·æ ¼/æ•°é‡å‡ä¸ºæ•´æ•°ï¼ˆç¾åˆ†åˆ¶ï¼‰ï¼Œç¦æ­¢ float/Decimal"ã€‚
    INT_SUFFIXES = (
        "_cents", "_ms", "spread", "levels",
        "min_price", "max_price", "min_volume",
    )

    for key, value in flat_patch.items():
        if any(key.endswith(suffix) for suffix in INT_SUFFIXES):
            # Python ä¸­ bool æ˜¯ int çš„å­ç±»ï¼Œå¿…é¡»æ˜¾å¼æ’é™¤
            if not isinstance(value, int) or isinstance(value, bool):
                errors.append(
                    f"[ç±»å‹é”™è¯¯] å‚æ•° {key} å¿…é¡»ä¸ºä¸¥æ ¼æ•´æ•° (int), "
                    f"å½“å‰ä¼ å…¥: {type(value).__name__} ({value})"
                )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3. æ‰‹ç»­è´¹æ„ŸçŸ¥ä¸ä»·å·®çº¦æŸ (Fee-Awareness Constraints)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # æ’®åˆå¼•æ“æ‰‹ç»­è´¹å…¬å¼ (å‘ä¸Šå–æ•´): (trade_value * fee_bps + 9999) // 10000
    # AMM çš„ spread å¿…é¡»è‡³å°‘è¦†ç›–æœ€åæƒ…å†µä¸‹çš„å•è¾¹ Maker æ‰‹ç»­è´¹ï¼Œå¦åˆ™å¿…ç„¶äºæŸã€‚
    # æœ€åæƒ…å†µ: é¡¶ä»·(max_price) Ã— æœ€å¤§å•ç¬”(max_order_qty) çš„æˆäº¤ã€‚
    max_price = merged.get("as_config", {}).get("max_price", 95)
    max_trade_value = max_price * max_order_qty
    max_maker_fee_cents = (max_trade_value * maker_fee_bps + 9999) // 10000

    stab_spread = merged.get("stabilization_config", {}).get("spread", 2)
    if stab_spread < max_maker_fee_cents:
        errors.append(
            f"[å€’æŒ‚é£é™©] stabilization_config.spread ({stab_spread}) "
            f"å°äºæœ€åæƒ…å†µ Maker æ‰‹ç»­è´¹ ({max_maker_fee_cents} Â¢)ã€‚"
            f"è®¡ç®—å‚æ•°: è´¹ç‡ {maker_fee_bps} bps, é¡¶ä»· {max_price} Â¢, "
            f"æœ€å¤§å•ç¬” {max_order_qty} ä»½ã€‚"
        )

    exp_spread = merged.get("exploration_config", {}).get("spread", 5)
    if exp_spread < max_maker_fee_cents:
        errors.append(
            f"[å€’æŒ‚é£é™©] exploration_config.spread ({exp_spread}) "
            f"å°äºæ‰€éœ€æ‰‹ç»­è´¹è¦†ç›– ({max_maker_fee_cents} Â¢)"
        )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4. è¶ŠæƒåŠ¨ä½œæ‹¦æˆª (System-Level Override Prevention)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # AMM æ— æƒè§¦å‘ç³»ç»Ÿçº§ HALT (markets.status = 'HALTED')ï¼Œ
    # åªèƒ½è§¦å‘ AMM_PAUSE (æ’¤å•+åœæ­¢å‘å•+è¿›å…¥ EMERGENCY çŠ¶æ€)ã€‚
    for key, value in flat_patch.items():
        if "action" in key.lower() or "trigger" in key.lower():
            if str(value).upper() == "HALT":
                errors.append(
                    f"[æ¶æ„è¶Šæƒ] AMM ä¸å…è®¸è§¦å‘å…¨å±€ HALT, "
                    f"è¯·ä½¿ç”¨ 'AMM_PAUSE': {key}={value}"
                )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5. ä¸šåŠ¡è”åŠ¨çº¦æŸ (Business Logic Constraints)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    defense = merged.get("defense_config", {})
    if defense.get("inventory_warning_threshold", 0.6) >= defense.get("inventory_danger_threshold", 0.8):
        errors.append("[é€»è¾‘é”™è¯¯] åº“å­˜é˜ˆå€¼å¿…é¡»æ»¡è¶³: warning < danger")
    if defense.get("inventory_danger_threshold", 0.8) >= defense.get("inventory_hard_limit", 0.9):
        errors.append("[é€»è¾‘é”™è¯¯] åº“å­˜é˜ˆå€¼å¿…é¡»æ»¡è¶³: danger < hard_limit")

    as_cfg = merged.get("as_config", {})
    if as_cfg.get("min_price", 1) >= as_cfg.get("max_price", 99):
        errors.append("[é€»è¾‘é”™è¯¯] ä»·æ ¼åŒºé—´å¿…é¡»æ»¡è¶³: min_price < max_price")

    if defense.get("extreme_price_kill", 5) >= defense.get("extreme_price_halt", 10):
        errors.append("[é€»è¾‘é”™è¯¯] æç«¯ä»·æ ¼é˜ˆå€¼å¿…é¡»æ»¡è¶³: extreme_price_kill < extreme_price_halt")

    pricing = merged.get("pricing_config", {})
    if pricing.get("anchor_initial_weight", 0.7) + pricing.get("microprice_weight", 0.2) > 1.0:
        errors.append("[é€»è¾‘é”™è¯¯] æƒé‡åˆ†é…è¶…é™: anchor_weight + microprice_weight å¿…é¡» â‰¤ 1.0")

    # å®‰å…¨è¾¹ç•Œ
    if defense.get("daily_loss_limit", 100000) > merged.get("initial_funding_cents", 0) * 0.5:
        errors.append("[å®‰å…¨è­¦å‘Š] daily_loss_limit è¶…è¿‡åˆå§‹èµ„é‡‘ 50%")

    return ValidationResult(valid=len(errors) == 0, errors=errors)


def _deep_merge(base: dict, update: dict) -> dict:
    """é€’å½’æ·±åº¦åˆå¹¶é…ç½®å­—å…¸"""
    merged = base.copy()
    for k, v in update.items():
        if isinstance(v, dict) and k in merged and isinstance(merged[k], dict):
            merged[k] = _deep_merge(merged[k], v)
        else:
            merged[k] = v
    return merged


def _flatten_dict(d: dict, parent_key: str = "", sep: str = ".") -> dict:
    """å±•å¹³åµŒå¥—å­—å…¸ä¾¿äºç»Ÿä¸€éå†æ ¡éªŒ"""
    items = []
    for k, v in d.items():
        new_key = f"{parent_key}{sep}{k}" if parent_key else k
        if isinstance(v, dict):
            items.extend(_flatten_dict(v, new_key, sep=sep).items())
        else:
            items.append((new_key, v))
    return dict(items)
```

**v1.2 ç›¸è¾ƒ v1.1 ä¼ªä»£ç çš„æ”¹è¿›ç‚¹**:

| æ”¹è¿› | è¯´æ˜ |
|------|------|
| å‡½æ•°ç­¾åå¢åŠ  `maker_fee_bps` + `max_order_qty` | ä» `markets` è¡¨åŠ¨æ€è·å–ï¼Œå–ä»£ç¡¬ç¼–ç çš„ `typical_trade_value` |
| `_flatten_dict` è¾…åŠ©å‡½æ•° | ç»Ÿä¸€å±•å¹³åµŒå¥—é…ç½®ï¼Œé¿å…é—æ¼æ·±å±‚é”® |
| `INT_SUFFIXES` åç¼€æ¨¡å¼ + `isinstance(bool)` æ’é™¤ | ä»æ¥å£å±‚åˆ‡æ–­ JSON float æ³¨å…¥ï¼ˆå¦‚ `2.0`ï¼‰ï¼Œé˜²æ­¢æµ®ç‚¹æ³„æ¼è‡³æ’®åˆå¼•æ“ |
| æœ€åæƒ…å†µæ‰‹ç»­è´¹è®¡ç®— | `max_price Ã— max_order_qty Ã— fee_bps` è€Œéå›ºå®šå€¼ï¼Œéšå¸‚åœºå‚æ•°åŠ¨æ€è°ƒæ•´ |
| è¶ŠæƒåŠ¨ä½œæ‹¦æˆª Step 4 | æ‰«æ patch ä¸­å« `action`/`trigger` çš„é”®å€¼ï¼Œæ‹¦æˆª `HALT` å­—é¢é‡ |
| é”™è¯¯æ¶ˆæ¯åˆ†ç±»æ ‡ç­¾ | `[è¶Šæƒ]` `[ç±»å‹é”™è¯¯]` `[å€’æŒ‚é£é™©]` `[é€»è¾‘é”™è¯¯]` ä¾¿äºæ—¥å¿—è¿‡æ»¤ |

### 4.3 å¹³æ»‘è¿‡æ¸¡ç­–ç•¥

éƒ¨åˆ†å‚æ•°å˜æ›´ä¸åº”ç¬é—´ç”Ÿæ•ˆï¼Œéœ€è¦å¹³æ»‘è¿‡æ¸¡ä»¥é¿å…å¸‚åœºå†²å‡»ï¼š

| å‚æ•°ç±»åˆ« | è¿‡æ¸¡ç­–ç•¥ | è¿‡æ¸¡æ—¶é•¿ |
|----------|----------|----------|
| spread ç±»ï¼ˆexploration/stabilizationï¼‰ | çº¿æ€§æ’å€¼ï¼Œæ¯ç§’æ­¥è¿› 1 cent | max(10s, Î”Ã—2s) |
| gamma ç±» | æŒ‡æ•°å¹³æ»‘ EMA(Î±=0.1) | ~30 ç§’æ”¶æ•› |
| levels / qty_ratio | ä¸‹ä¸ªé‡æŒ‚å‘¨æœŸç›´æ¥ç”Ÿæ•ˆ | 0ï¼ˆå³æ—¶ï¼‰ |
| defense é˜ˆå€¼ | ç«‹å³ç”Ÿæ•ˆï¼ˆå®‰å…¨ä¼˜å…ˆï¼‰ | 0ï¼ˆå³æ—¶ï¼‰ |
| daily_loss_limit è°ƒä½ | ç«‹å³ç”Ÿæ•ˆ + è‹¥å½“å‰å·²è¶…æ–°é™é¢åˆ™è§¦å‘ KILL | 0ï¼ˆå³æ—¶ï¼‰ |

---

## ç¬¬äº”ç« ï¼šå¯åŠ¨æ—¶é…ç½®åŠ è½½æµç¨‹

### 5.1 åŠ è½½åºåˆ—

```
AMM è¿›ç¨‹å¯åŠ¨
  â”‚
  â”œâ”€ Step 1: åŠ è½½ config/{env}.yaml (Layer 1)
  â”‚  Â· è§£æ global_defaults + market_overrides[market_id]
  â”‚  Â· æ ¡éªŒç±»å‹ä¸èŒƒå›´
  â”‚  Â· ç”Ÿæˆ AMMConfigV6 åŸºå‡†å®ä¾‹
  â”‚
  â”œâ”€ Step 2: æ£€æŸ¥ Redis amm:config:{market_id} (Layer 2)
  â”‚  Â· å¦‚å­˜åœ¨ï¼Œè§£æ override_json
  â”‚  Â· å¢é‡åˆå¹¶è¦†ç›–åŸºå‡†é…ç½®
  â”‚  Â· é‡æ–°æ ¡éªŒè”åŠ¨çº¦æŸ
  â”‚
  â”œâ”€ Step 3: å†™å…¥è¿è¡Œæ—¶å¿«ç…§
  â”‚  Â· å°†æœ€ç»ˆåˆå¹¶é…ç½®åºåˆ—åŒ–å†™å…¥ Redis amm:config:{market_id}:snapshot
  â”‚  Â· è®°å½• boot_config_version ç”¨äºå®¡è®¡
  â”‚
  â”œâ”€ Step 4: æ³¨å†Œé…ç½®çƒ­æ›´æ–° Watcher
  â”‚  Â· å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ config_reload_interval_ms æ£€æŸ¥ config_versionï¼‰
  â”‚  Â· å˜æ›´ â†’ å¢é‡åˆå¹¶ â†’ æ ¡éªŒ â†’ åŸå­æ›¿æ¢å†…å­˜é…ç½®
  â”‚
  â””â”€ Step 5: è®°å½•å¯åŠ¨æ—¥å¿—
     Â· å®Œæ•´é…ç½®å¿«ç…§å†™å…¥å®¡è®¡æ—¥å¿—
     Â· æ ‡è®°ä»»ä½•ä» Redis è¦†ç›–äº† YAML çš„å‚æ•°
```

### 5.2 é…ç½®åŠ è½½å¤±è´¥å¤„ç†

| é˜¶æ®µ | å¤±è´¥ç±»å‹ | å¤„ç†ç­–ç•¥ |
|------|---------|----------|
| Step 1 | YAML æ–‡ä»¶ç¼ºå¤±/è§£æé”™è¯¯ | **è¿›ç¨‹æ‹’ç»å¯åŠ¨**ï¼Œè¾“å‡ºé”™è¯¯åˆ° stderr |
| Step 1 | å‚æ•°è¶…å‡ºåˆæ³•èŒƒå›´ | **è¿›ç¨‹æ‹’ç»å¯åŠ¨**ï¼Œåˆ—å‡ºå…¨éƒ¨è¿è§„å‚æ•° |
| Step 2 | Redis ä¸å¯è¾¾ | **é™çº§å¯åŠ¨**ï¼Œä»…ä½¿ç”¨ YAML é…ç½®ï¼Œå‘Šè­¦é€šçŸ¥ |
| Step 2 | Redis è¦†ç›–å‚æ•°è¿åçº¦æŸ | **å¿½ç•¥è¿è§„è¦†ç›–**ï¼Œä½¿ç”¨ YAML å€¼ï¼Œå‘Šè­¦é€šçŸ¥ |
| Step 4 | çƒ­æ›´æ–°æ ¡éªŒå¤±è´¥ | **æ‹’ç»æœ¬æ¬¡æ›´æ–°**ï¼Œä¿æŒå½“å‰é…ç½®ï¼Œå‘Šè­¦é€šçŸ¥ |

---

## ç¬¬å…­ç« ï¼šåœºæ™¯åŒ–è°ƒå‚æŒ‡å—

### 6.1 æ–°å¸‚åœºä¸Šçº¿

**ç›®æ ‡**: æœ€å°åŒ–åˆå§‹é£é™©ï¼Œå¿«é€Ÿå‘ç°å…¬å…ä»·æ ¼ã€‚

```yaml
# æ¨èé…ç½®è¦†ç›–
exploration_config:
  spread: 8              # å®½ä»·å·®ï¼Œé™ä½åˆå§‹æŸå¤±
  qty_ratio: 0.15        # æå°é‡è¯•æ¢
  max_duration_ms: 7200000  # å»¶é•¿æ¢ç´¢æœŸè‡³ 2 å°æ—¶
  levels: 3              # å‡å°‘å±‚æ•°ï¼Œé›†ä¸­æµåŠ¨æ€§

stabilization_config:
  spread: 3              # ç¨³å®šæœŸä¹Ÿä¿æŒè¾ƒå®½
  qty_ratio: 0.5         # é€æ­¥åŠ é‡

as_config:
  gamma_mid: 2.0         # åä¿å®ˆ

defense_config:
  daily_loss_limit: 30000  # é™åˆ¶åˆæœŸæŸå¤±è‡³ $300
```

**å…³é”®æŒ‡æ ‡è§‚å¯Ÿ**: é¦–å°æ—¶æˆäº¤é‡ã€ä¹°å–å•æ¯”ä¾‹ã€ä»·æ ¼æ”¶æ•›è¶‹åŠ¿ã€‚è‹¥ 30 åˆ†é’Ÿæ— æˆäº¤ï¼Œè€ƒè™‘æ‰‹åŠ¨è°ƒä½ `exploration_config.spread`ã€‚

### 6.2 é«˜æ³¢åŠ¨åº”æ€¥

**è§¦å‘æ¡ä»¶**: 5 åˆ†é’Ÿæ³¢åŠ¨ç‡ > 10%ï¼Œæˆ– VPIN > 0.70ã€‚

```yaml
# åº”æ€¥é…ç½®ï¼ˆé€šè¿‡çƒ­æ›´æ–°æ¨é€ï¼Œå¯è®¾ TTL 30 åˆ†é’Ÿè‡ªåŠ¨æ¢å¤ï¼‰
stabilization_config:
  spread: 5              # ç´§æ€¥æ‹‰å®½
  qty_ratio: 0.3         # é™é‡

defense_config:
  price_jump_threshold: 0.10  # æ›´æ•æ„Ÿçš„è·³å˜æ£€æµ‹
  inventory_warning_threshold: 0.50  # æå‰é¢„è­¦

lvr_defense_config:
  post_fill_delay_ms: 5000  # å»¶é•¿æˆäº¤å†·å´
  event_spread_multiplier: 8.0
```

**TTL è¦†ç›–æœºåˆ¶**: Redis çƒ­æ›´æ–°æ”¯æŒ `override_ttl_ms` å­—æ®µã€‚30 åˆ†é’Ÿåè¦†ç›–è‡ªåŠ¨è¿‡æœŸï¼Œé…ç½®å›é€€è‡³ YAML åŸºå‡†å€¼ã€‚é€‚åˆä¸´æ—¶åº”æ€¥ä½¿ç”¨ã€‚

### 6.3 åº“å­˜å¤±è¡¡ä¿®å¤

**åœºæ™¯**: ä¸€ä¾§åº“å­˜è¶…è¿‡ 70%ï¼Œéœ€è¦é€æ­¥å›å½’å¹³è¡¡ã€‚

```yaml
as_config:
  spread_skew_factor: 0.8    # åŠ å¤§åæ–œå¯¹ä»·å·®çš„å½±å“
  qty_skew_factor: 0.5       # åŠ å¤§åæ–œå¯¹æŒ‚å•é‡çš„å½±å“

defense_config:
  distress_max_discount: 8   # æé«˜å›°å¢ƒæŠ˜ä»·
  inventory_warning_threshold: 0.55  # æå‰ååº”

# å¦‚æœ auto_reinvest æ˜¯é—®é¢˜æ ¹æºï¼ˆMint åŠ å‰§å¤±è¡¡ï¼‰
auto_reinvest_enabled: false  # æš‚åœ Mint
```

**æ¢å¤æµç¨‹**: åº“å­˜åæ–œé™è‡³ 40% ä»¥ä¸‹åï¼Œé€æ­¥æ¢å¤å‚æ•°è‡³é»˜è®¤å€¼ã€‚å»ºè®®åˆ†ä¸¤æ¬¡è°ƒæ•´ï¼Œé—´éš” 15 åˆ†é’Ÿè§‚å¯Ÿæ•ˆæœã€‚

### 6.4 å¸‚åœºä¸´è¿‘åˆ°æœŸ

**åœºæ™¯**: å¸‚åœºå°†åœ¨ 24-48 å°æ—¶å†…ç»“ç®—ï¼Œéœ€è¦æ”¶ç¼©é£é™©æ•å£ã€‚

```yaml
as_config:
  gamma_short: 4.0       # å¤§å¹…æé«˜Î³ï¼ŒåŠ é€Ÿæ¸…åº“å­˜
  min_price: 3            # æ”¾å®½æç«¯ä»·æ ¼ä¸‹é™
  max_price: 97           # æ”¾å®½æç«¯ä»·æ ¼ä¸Šé™

stabilization_config:
  qty_ratio: 0.3          # ç¼©é‡
  spread: 1               # å¯æ”¶çª„ä»·å·®åŠ é€Ÿæˆäº¤

defense_config:
  extreme_price_kill: 2   # æ”¾å®½æç«¯åŒº
  daily_loss_limit: 20000 # æ”¶ç´§æ­¢æŸ

auto_reinvest_enabled: false  # åœæ­¢ Mint
```

### 6.5 ä½æµåŠ¨æ€§ç¯å¢ƒ

**åœºæ™¯**: å¸‚åœºæŒ‚å•ç°¿ç¨€è–„ï¼ˆéAMMæ·±åº¦ < 20ä»½ï¼‰ï¼Œéœ€è¦AMMæä¾›ä¸»è¦æµåŠ¨æ€§ã€‚

```yaml
pricing_config:
  microprice_weight: 0.05        # é™ä½å¾®ä»·æ ¼æƒé‡ï¼ˆæ·±åº¦ä¸å¤Ÿä¸å¯ä¿¡ï¼‰
  microprice_min_depth: 5        # é™ä½æ¿€æ´»é—¨æ§›
  base_learning_rate: 0.08       # é™ä½å­¦ä¹ ç‡ï¼Œé¿å…å™ªå£°é©±åŠ¨

exploration_config:
  spread: 4
  levels: 7                      # å¢åŠ å±‚æ•°è¦†ç›–æ›´å®½ä»·æ ¼åŒºé—´

stabilization_config:
  spread: 2
  levels: 7
  qty_ratio: 1.5                 # åŠ é‡ï¼Œæˆä¸ºä¸»è¦æµåŠ¨æ€§æä¾›è€…
```

---

## ç¬¬ä¸ƒç« ï¼šå‚æ•°è”åŠ¨å…³ç³»å›¾

### 7.1 è”åŠ¨çº¦æŸæ¸…å•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å‚æ•°è”åŠ¨å…³ç³»                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€ ThreeLayerPricing â”€â”€â”                                          â”‚
â”‚  â”‚ anchor_weight         â”‚                                          â”‚
â”‚  â”‚      +                â”‚                                          â”‚
â”‚  â”‚ microprice_weight     â”‚â”€â”€ â‰¤ 1.0 (å‰©ä½™ç»™ posterior)               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€ ASConfig â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚ min_price             â”‚                                          â”‚
â”‚  â”‚      <                â”‚â”€â”€ ä¸” min_price + spread < max_price      â”‚
â”‚  â”‚ max_price             â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚          â”‚ spread å¼•ç”¨                                               â”‚
â”‚          â–¼                                                           â”‚
â”‚  â”Œâ”€â”€ Exploration/Stabilization â”€â”€â”                                  â”‚
â”‚  â”‚ spread (both phases)          â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€ DefenseStack â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚ warning: 0.60         â”‚                                          â”‚
â”‚  â”‚    <                  â”‚                                          â”‚
â”‚  â”‚ danger:  0.80         â”‚                                          â”‚
â”‚  â”‚    <                  â”‚                                          â”‚
â”‚  â”‚ hard_limit: 0.90      â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚          â”‚                                                           â”‚
â”‚  â”‚ spread_multiplier_warning < spread_multiplier_danger              â”‚
â”‚  â”‚ extreme_price_kill < extreme_price_halt                          â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€ PhaseRollback â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚ pnl_rollback_thresholdâ”‚â”€â”€ â‰¤ defense.daily_loss_limit             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€ VolatilityEstimator â”                                          â”‚
â”‚  â”‚ sigma_min_cents       â”‚                                          â”‚
â”‚  â”‚    <                  â”‚                                          â”‚
â”‚  â”‚ sigma_max_cents       â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€ æ‰‹ç»­è´¹æ„ŸçŸ¥ (v1.1) â”€â”€â”                                          â”‚
â”‚  â”‚ spread (ä¸¤é˜¶æ®µ)       â”‚â”€â”€ > estimated_fee_per_side (bps æ¨å¯¼)    â”‚
â”‚  â”‚ æ¥æº: market_taker_fee_bps / market_maker_fee_bps                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€ è·¨æ¨¡å—è”åŠ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚ daily_loss_limit â‰¤ initial_funding_cents Ã— 0.50 (å»ºè®®)           â”‚
â”‚  â”‚ auto_reinvest_threshold â‰¤ initial_funding_cents Ã— 0.80 (å»ºè®®)    â”‚
â”‚  â”‚ pnl_rollback_threshold = daily_loss_limit Ã— 0.50 (é»˜è®¤è”åŠ¨)      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 å‚æ•°å˜æ›´å½±å“é“¾

å½“ä¿®æ”¹æ ¸å¿ƒå‚æ•°æ—¶ï¼Œéœ€è¦è¯„ä¼°ä¸‹æ¸¸å½±å“ï¼š

| ä¿®æ”¹å‚æ•° | ç›´æ¥å½±å“ | é—´æ¥å½±å“ | å»ºè®®æ“ä½œ |
|----------|----------|----------|----------|
| `gamma_*` | ä¿ç•™ä»·æ ¼åç§»å¹…åº¦ | åº“å­˜å›å½’é€Ÿåº¦ã€PnL æ³¢åŠ¨ | è§‚å¯Ÿ 15 åˆ†é’Ÿåº“å­˜è¶‹åŠ¿ |
| `daily_loss_limit` è°ƒä½ | KILL è§¦å‘é˜ˆå€¼ | `pnl_rollback_threshold` éœ€åŒæ­¥è°ƒä½ | åŒæ­¥ä¿®æ”¹å›é€€é˜ˆå€¼ |
| `spread` (ç¨³å®šæœŸ) æ”¶çª„ | æŠ¥ä»·æ›´ç´§å¯† | æˆäº¤é¢‘ç‡æå‡ã€å•ç¬”æŸå¤±é£é™©å¢å¤§ | ç¡®è®¤ defense é˜ˆå€¼ä»æœ‰æ•ˆ |
| `levels` å¢åŠ  | æ›´å¤šæŒ‚å• | Replace é¢‘ç‡æå‡ã€API è°ƒç”¨é‡å¢å¤§ | ç¡®è®¤ä¸è¶… replace_rate_limit |
| `sigma_min_cents` è°ƒé«˜ | A-S è°ƒæ•´é‡ä¸‹é™æé«˜ | æç«¯æƒ…å†µä¸‹ä»·å·®å¯èƒ½è¿‡å®½ | ç¡®è®¤ä¸è¶…å‡º spread ä¸Šé™ |

---

## ç¬¬å…«ç« ï¼šå‘Šè­¦ä¸ç›‘æ§é…ç½®

### 8.1 å‘Šè­¦é˜ˆå€¼é…ç½®

| å‘Šè­¦é¡¹ | é˜ˆå€¼ | çº§åˆ« | é€šçŸ¥æ¸ é“ | æ¥æº |
|--------|------|------|----------|------|
| æ—¥äºæŸæ¥è¿‘é™é¢ | > daily_loss_limit Ã— 80% | WARNING | Slack + ä»ªè¡¨ç›˜ | é˜²å¾¡å±‚ |
| æ—¥äºæŸè§¦å‘ KILL | > daily_loss_limit | CRITICAL | Slack + PagerDuty | é˜²å¾¡å±‚ |
| åº“å­˜åæ–œé¢„è­¦ | > inventory_warning_threshold | WARNING | ä»ªè¡¨ç›˜ | é˜²å¾¡å±‚ |
| åº“å­˜åæ–œå±é™© | > inventory_danger_threshold | ERROR | Slack | é˜²å¾¡å±‚ |
| Redis â†” DB å¯¹è´¦å¼‚å¸¸ | è¶…å‡º tolerance | ERROR | Slack | æ•°æ®åŒæ­¥ |
| WebSocket æ–­å¼€ | è¶…è¿‡ 5 ç§’ | ERROR | Slack | è¿æ¥ç®¡ç† |
| API é”™è¯¯ç‡ | > api_error_threshold | ERROR | Slack + PagerDuty | æ¥å£å±‚ |
| Oracle ä»·æ ¼åå·® | > oracle_deviation_warning | WARNING | ä»ªè¡¨ç›˜ | Oracle Guard |
| VPIN å¼‚å¸¸ | > vpin_threshold | WARNING | Slack | å¾®è§‚ç»“æ„ |
| é…ç½®çƒ­æ›´æ–°å¤±è´¥ | æ ¡éªŒä¸é€šè¿‡ | WARNING | Slack | é…ç½®ç®¡ç† |

### 8.2 ç›‘æ§æŒ‡æ ‡ï¼ˆå¯¹é½ WAL æ–‡æ¡£ Â§7ï¼‰

| æŒ‡æ ‡ | é‡‡é›†é¢‘ç‡ | å­˜å‚¨ | è¯´æ˜ |
|------|----------|------|------|
| `amm_pnl_daily_cents` | æ¯ç¬”äº¤æ˜“ | Prometheus + Redis | æ—¥å†…å·²å®ç° + æœªå®ç°ç›ˆäº |
| `amm_inventory_skew` | æ¯ç§’ | Prometheus | abs(YES-NO) / max(YES+NO, 1) |
| `amm_spread_current_cents` | æ¯æ¬¡é‡æŒ‚ | Prometheus | å½“å‰å®é™…ä»·å·® |
| `amm_defense_level` | çŠ¶æ€å˜æ›´æ—¶ | Prometheus | NORMAL/WIDEN/ONE_SIDE/KILL_SWITCH/AMM_PAUSE |
| `amm_phase` | çŠ¶æ€å˜æ›´æ—¶ | Prometheus | EXPLORATION/STABILIZATION |
| `amm_replace_latency_ms` | æ¯æ¬¡ Replace | Prometheus | Replace API è°ƒç”¨å»¶è¿Ÿ |
| `amm_config_version` | æ¯æ¬¡å˜æ›´ | Prometheus | å½“å‰é…ç½®ç‰ˆæœ¬å· |
| `amm_reconciliation_drift` | æ¯æ¬¡å¯¹è´¦ | Prometheus | Redis â†” DB å·®å€¼ |

---

## ç¬¬ä¹ç« ï¼šè°ƒå‚æ“ä½œè§„èŒƒ

### 9.1 å˜æ›´æµç¨‹

```
è¿è¥äººå‘˜æå‡ºè°ƒå‚éœ€æ±‚
  â”‚
  â”œâ”€ ä½é£é™©å˜æ›´ï¼ˆspreadã€levels å¾®è°ƒï¼‰
  â”‚  â””â”€ ç›´æ¥é€šè¿‡ç®¡ç†æ¥å£æ¨é€ â†’ è‡ªåŠ¨æ ¡éªŒ â†’ ç”Ÿæ•ˆ â†’ è§‚å¯Ÿ 15 åˆ†é’Ÿ
  â”‚
  â”œâ”€ ä¸­é£é™©å˜æ›´ï¼ˆgammaã€defense é˜ˆå€¼è°ƒæ•´ï¼‰
  â”‚  â””â”€ æäº¤å˜æ›´å• â†’ æŠ€æœ¯ç¡®è®¤è”åŠ¨å½±å“ â†’ æ¨é€ â†’ è§‚å¯Ÿ 30 åˆ†é’Ÿ
  â”‚
  â””â”€ é«˜é£é™©å˜æ›´ï¼ˆdaily_loss_limit å¤§å¹…è°ƒæ•´ã€oracle_guard å…³é—­ï¼‰
     â””â”€ æäº¤å˜æ›´å• â†’ åŒäººå®¡æ‰¹ â†’ æ¨é€ â†’ æŒç»­ç›‘æ§ 1 å°æ—¶
```

### 9.2 å›æ»šç­–ç•¥

| åœºæ™¯ | å›æ»šæ–¹å¼ |
|------|---------|
| çƒ­æ›´æ–°åæ•ˆæœä¸ä½³ | æ¨é€æ—§é…ç½®å€¼è¦†ç›–ï¼ˆRedis å±‚ï¼‰ |
| çƒ­æ›´æ–°å¯¼è‡´å¼‚å¸¸è¡Œä¸º | åˆ é™¤ Redis override_json â†’ å›é€€è‡³ YAML åŸºå‡† |
| TTL è¦†ç›–è‡ªç„¶è¿‡æœŸ | è‡ªåŠ¨å›é€€ï¼Œæ— éœ€æ“ä½œ |
| YAML å˜æ›´åé‡å¯å¼‚å¸¸ | `git revert` â†’ é‡æ–°éƒ¨ç½² |

### 9.3 å®¡è®¡æ—¥å¿—æ ¼å¼

æ¯æ¬¡é…ç½®å˜æ›´å†™å…¥å®¡è®¡è¡¨ï¼š

```json
{
  "event_type": "CONFIG_UPDATE",
  "timestamp": "2026-02-28T10:30:00Z",
  "market_id": "market_uuid_001",
  "operator": "ops_team_alice",
  "config_version": 42,
  "changes": {
    "as_config.gamma_mid": {"old": 1.5, "new": 2.0},
    "defense_config.daily_loss_limit": {"old": 100000, "new": 80000}
  },
  "validation_result": "PASS",
  "override_ttl_ms": null,
  "source": "admin_api"
}
```

---

## é™„å½•

### é™„å½• Aï¼šå‚æ•°é€ŸæŸ¥è¡¨ï¼ˆæŒ‰é£é™©åˆ†çº§ï¼‰

#### ğŸŸ¢ ä½é£é™© â€” å¯éšæ—¶å¾®è°ƒ

| å‚æ•° | é»˜è®¤ | èŒƒå›´ |
|------|------|------|
| exploration_config.spread | 5 | 1â€“20 |
| exploration_config.levels | 5 | 2â€“10 |
| stabilization_config.spread | 2 | 1â€“10 |
| stabilization_config.levels | 5 | 2â€“10 |
| stabilization_config.cancel_on_price_move | 0.02 | 0.005â€“0.10 |
| stabilization_config.max_order_age_ms | 300000 | 30000â€“600000 |
| gradient_config.* | è§ Â§3.7 | è§ Â§3.7 |
| volatility_estimator.window_size | 30 | 5â€“100 |

#### ğŸŸ¡ ä¸­é£é™© â€” éœ€è¯„ä¼°è”åŠ¨å½±å“

| å‚æ•° | é»˜è®¤ | èŒƒå›´ |
|------|------|------|
| as_config.gamma_* | 2.5/1.5/0.8 | è§ Â§3.6 |
| as_config.spread_skew_factor | 0.5 | 0.0â€“1.0 |
| defense_config.inventory_*_threshold | 0.60/0.80/0.90 | è§ Â§3.8.2 |
| pricing_config.base_learning_rate | 0.15 | 0.02â€“0.30 |
| stabilization_config.qty_ratio | 1.0 | 0.20â€“2.0 |
| phase_rollback.volatility_threshold | 0.10 | 0.03â€“0.30 |

#### ğŸ”´ é«˜é£é™© â€” éœ€åŒäººå®¡æ‰¹

| å‚æ•° | é»˜è®¤ | èŒƒå›´ |
|------|------|------|
| defense_config.daily_loss_limit | 100000 | 10000â€“1000000 |
| defense_config.inventory_hard_limit | 0.90 | 0.80â€“0.99 |
| oracle_guard_enabled | true | â€” |
| auto_reinvest_enabled | true | â€” |
| lvr_defense.velocity_kill_ratio | 0.20 | 0.05â€“0.50 |
| defense_config.extreme_price_kill | 5 | 1â€“20 |

### é™„å½• Bï¼šç¯å¢ƒé…ç½®å·®å¼‚

| å‚æ•° | dev | staging | prod |
|------|-----|---------|------|
| initial_funding_cents | 100000 ($1K) | 500000 ($5K) | æŒ‰å¸‚åœºå®š |
| daily_loss_limit | 10000 ($100) | 50000 ($500) | 100000 ($1K) |
| amm_rate_limit | 100/min | 300/min | 600/min |
| replace_rate_limit | 100/min | 200/min | 400/min |
| reconciliation_interval_ms | 60000 | 120000 | 300000 |
| api_error_threshold | 0.50 | 0.20 | 0.10 |

### é™„å½• Cï¼šé…ç½® JSON Schemaï¼ˆä¾›ç®¡ç†æ¥å£æ ¡éªŒï¼‰

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "as_config.gamma_short": {"type": "number", "minimum": 0.5, "maximum": 5.0},
    "as_config.gamma_mid": {"type": "number", "minimum": 0.5, "maximum": 3.0},
    "as_config.gamma_long": {"type": "number", "minimum": 0.1, "maximum": 2.0},
    "as_config.time_smoothing_kappa": {"type": "number", "minimum": 1.0, "maximum": 168.0},
    "as_config.spread_skew_factor": {"type": "number", "minimum": 0.0, "maximum": 1.0},
    "as_config.qty_skew_factor": {"type": "number", "minimum": 0.0, "maximum": 1.0},
    "as_config.min_price": {"type": "integer", "minimum": 1, "maximum": 30},
    "as_config.max_price": {"type": "integer", "minimum": 70, "maximum": 99},
    "as_config.min_adjustment": {"type": "integer", "minimum": 0, "maximum": 5},
    "exploration_config.spread": {"type": "integer", "minimum": 1, "maximum": 20},
    "exploration_config.qty_ratio": {"type": "number", "minimum": 0.05, "maximum": 0.50},
    "exploration_config.levels": {"type": "integer", "minimum": 2, "maximum": 10},
    "exploration_config.cancel_interval_ms": {"type": "integer", "minimum": 5000, "maximum": 120000},
    "exploration_config.max_duration_ms": {"type": "integer", "minimum": 300000, "maximum": 86400000},
    "stabilization_config.spread": {"type": "integer", "minimum": 1, "maximum": 10},
    "stabilization_config.qty_ratio": {"type": "number", "minimum": 0.20, "maximum": 2.0},
    "stabilization_config.geometric_ratio": {"type": "number", "minimum": 1.01, "maximum": 1.20},
    "stabilization_config.qty_decay": {"type": "number", "minimum": 0.30, "maximum": 1.0},
    "stabilization_config.max_order_age_ms": {"type": "integer", "minimum": 30000, "maximum": 600000},
    "defense_config.daily_loss_limit": {"type": "integer", "minimum": 10000, "maximum": 1000000},
    "defense_config.inventory_warning_threshold": {"type": "number", "minimum": 0.30, "maximum": 0.80},
    "defense_config.inventory_danger_threshold": {"type": "number", "minimum": 0.50, "maximum": 0.95},
    "defense_config.inventory_hard_limit": {"type": "number", "minimum": 0.80, "maximum": 0.99},
    "defense_config.extreme_price_kill": {"type": "integer", "minimum": 1, "maximum": 20},
    "defense_config.extreme_price_halt": {"type": "integer", "minimum": 5, "maximum": 30}
  }
}
```

### é™„å½• Dï¼šè·¨æ–‡æ¡£å¼•ç”¨

| å¼•ç”¨å†…å®¹ | æ‰€åœ¨æ–‡æ¡£ | ç« èŠ‚ |
|---------|---------|------|
| å…¨éƒ¨ Config ç±»å®šä¹‰ä¸ç®—æ³•æ¨å¯¼ | AMM æ¨¡å—è®¾è®¡ v7.1 | Â§3-Â§13 |
| Redis æ•°æ®ç»“æ„å®šä¹‰ | æ•°æ®å­—å…¸ v1.3 | Â§4 |
| Redis â†” DB å¯¹è´¦é€»è¾‘ | æ•°æ®å­—å…¸ v1.3 | Â§7.3 |
| API é€Ÿç‡é™åˆ¶ä¸è®¤è¯ | æ¥å£ä¸äº‹ä»¶æµå¥‘çº¦ v1.4 | Â§2.2 |
| WebSocket æ¨é€åè®® | æ¥å£ä¸äº‹ä»¶æµå¥‘çº¦ v1.4 | Â§7 |
| ç›‘æ§æŒ‡æ ‡ä¸å‘Šè­¦é€šé“ | WAL ä¸æ•…éšœæ¢å¤è®¾è®¡ v1.1 | Â§7 |
| æ’ç­‰å¼æ ¡éªŒé—´éš” | æ’®åˆå¼•æ“è®¾è®¡ v1.2 | Â§11 |
| ç†”æ–­è§¦å‘ç±»å‹ | WAL ä¸æ•…éšœæ¢å¤è®¾è®¡ v1.1 | Â§4 |
| Mint/Burn å¯¹ Redis çš„ç›´æ¥æ›´æ–° | æ¥å£ä¸äº‹ä»¶æµå¥‘çº¦ v1.4 | Â§5.1 |
| æ‰‹ç»­è´¹å…¬å¼ | æ’®åˆå¼•æ“è®¾è®¡ v1.2 | Â§7.2 |

### é™„å½• Eï¼šç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¸»è¦å˜æ›´ |
|------|------|---------|
| v1.0 | 2026-02-28 | åˆå§‹ç‰ˆæœ¬ã€‚æ±‡æ€» 11 ä¸ª Config ç±»å…± 87+ å‚æ•°ï¼›å®šä¹‰ä¸‰å±‚é…ç½®æ¶æ„ï¼ˆYAML â†’ Redis â†’ å†…å­˜ï¼‰ï¼›æ˜ç¡®çƒ­æ›´æ–°/å†·æ›´æ–°/é”å®šåˆ†ç±»ï¼›ç¼–å†™ 5 ä¸ªåœºæ™¯åŒ–è°ƒå‚æŒ‡å—ï¼›å»ºç«‹è”åŠ¨çº¦æŸå›¾å’Œå®‰å…¨æ ¡éªŒé“¾ã€‚ |
| v1.1 | 2026-02-28 | **å®¡è®¡ä¿®æ­£ 4 é¡¹**: (1) Ïƒ_cents å‚æ•°ç±»å‹ floatâ†’intï¼Œå¯¹é½æ’®åˆå¼•æ“"ç¦æ­¢ float"å…¨å±€çº¦æŸï¼Œå¢åŠ è®¢å•ç”Ÿæˆè¾¹ç•Œ round_to_int() è¯´æ˜ï¼›(2) æ–°å¢æ‰‹ç»­è´¹æ„ŸçŸ¥æ ¡éªŒï¼ˆÂ§4.2 Step 5ï¼‰ï¼Œé˜²æ­¢ spread â‰¤ fee çš„ç¡®å®šæ€§äºæŸï¼Œå¢åŠ  market_taker_fee_bps / market_maker_fee_bps ç³»ç»Ÿå‚æ•°ï¼›(3) AMM é˜²å¾¡åŠ¨ä½œ HALTâ†’AMM_PAUSE æœ¯è¯­ä¿®æ­£ï¼Œæ˜ç¡® AMM æ— æƒè§¦å‘ç³»ç»Ÿçº§ HALTEDï¼ˆå¯¹é½ WAL v1.1 Â§5ï¼‰ï¼›(4) è¡¥å……åº“å­˜æ•°æ®æƒå¨æ€§åŸåˆ™ï¼ˆÂ§3.8.2ï¼‰ï¼Œæ˜ç¡® AMM åº“å­˜å¿…é¡»æ¥è‡ª Redis/DBã€auto_netting_enabled=false é¢„é˜²æªæ–½ã€Mint/Burn ç›´æ›´æ–°è·¯å¾„ã€‚ |
| v1.2 | 2026-02-28 | **æ ¡éªŒçŸ©é˜µé‡æ„ + é˜²å¾¡çºµæ·±**: (1) Â§4.2 `validate_config_update` å…¨é¢é‡å†™ â€” å¼•å…¥ `_flatten_dict` é€’å½’æ‰å¹³åŒ–æ›¿ä»£æ‰‹åŠ¨éå†ï¼Œ`INT_SUFFIXES` æ¨¡å¼åŒ¹é…å®ç°å¼ºæ•´æ•°ç±»å‹æ–­è¨€ï¼ˆå« `isinstance(bool)` æ’é™¤ï¼‰ï¼Œæ‰‹ç»­è´¹æ„ŸçŸ¥æ”¹ä¸ºé€šè¿‡å‡½æ•°å‚æ•° `maker_fee_bps` + `max_order_qty` åŠ¨æ€è®¡ç®—æœ€åæƒ…å½¢ï¼ˆæ›¿ä»£ç¡¬ç¼–ç  `typical_trade_value`ï¼‰ï¼Œæ–°å¢ Step 4 ç³»ç»Ÿçº§è¶Šæƒæ‹¦æˆªï¼ˆæ‰«æ action/trigger é”®å€¼ä¸­çš„ "HALT" å­—é¢é‡ï¼‰ï¼›(2) Â§3.8.2 è¡¥å…… Netting äº‹ä»¶è®¢é˜… defense-in-depth æœºåˆ¶ã€‚ |
| v1.3 | 2026-02-28 | **æ–‡æ¡£ä¸ä»£ç å¯¹é½å®¡è®¡**: (1) Â§3.8.2 Auto-Netting é¢„é˜²è¯´æ˜å¢åŠ  MVP å®ç°çŠ¶æ€æ ‡æ³¨â€”â€”æ¸…ç®—ä»£ç  `execute_netting_if_needed` å°šæœªè¯»å– `auto_netting_enabled` æ ‡å¿—ï¼ˆP0 Blockerï¼‰ï¼›(2) Â§3.8.2 Netting é˜²å¾¡çºµæ·±æ”¹ä¸º MVP/Phase 2 åˆ†å±‚â€”â€”MVP ä¾èµ–å®šæœŸå¯¹è´¦å‘ç°åç§»ï¼ŒPhase 2 ä½¿ç”¨ Redis Pub/Sub å®æ—¶è®¢é˜…ï¼›(3) å¯¹é½æ¥å£å¥‘çº¦ v1.3 ä¸­ Kafkaâ†’REST è½®è¯¢çš„æ•°æ®æºå˜æ›´ã€‚ |

---

*æ–‡æ¡£ç»“æŸ*
